<!doctype html>
<html>
	<head>
		<title>Muon Redux</title>
		<link href="//richorama.blob.core.windows.net/bootstrap.min.css" rel="stylesheet">
		<link href="//richorama.blob.core.windows.net/bootstrap-responsive.css" rel="stylesheet">
		<script src="//richorama.blob.core.windows.net/muonredux.js"></script>

		<!--script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>
		<script src="http://twitter.github.com/bootstrap/assets/js/bootstrap-modal.js"></script>
		<script src="https://raw.github.com/makeusabrew/bootbox/v3.0.0/bootbox.min.js"></script>
		<script src="http://jquery-xml2json-plugin.googlecode.com/svn/trunk/jquery.xml2json.js"></script>
		<script src="http://cloud.github.com/downloads/wycats/handlebars.js/handlebars-1.0.rc.1.js"></script>
		<script src="https://raw.github.com/coreyti/showdown/master/src/showdown.js"></script>
	    <script src="http://documentcloud.github.com/underscore/underscore.js"></script>
      	<script src="http://documentcloud.github.com/backbone/backbone.js"></script>
		<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.9.1/dropbox.min.js"></script-->

	
		<style type="text/css" media="screen">
		    #editor { 
		        position: absolute;
		        top: 0;
		        right: 0;
		        bottom: 1px;
		        left: 1px;
		    }
			.ace_editor_wrapper {
				height: 500px;
				position: relative;
				border: 1px solid #DDD;
				border-radius: 4px;
				border-bottom-right-radius: 0px;
				margin-top: 5px;
			}	
			.toolbar {
				background:whitesmoke;
				margin-bottom:10px;
			}	    
			.toolbar-buttons{
				float:left;
				padding:9px;
				font-size:26px;
			}
			.name{
				float:right;
				margin-right: 10px;
				margin-top: 10px;
			}
		</style>      	
	</head>
	<body>
		<script>
/*
 _ __ ___  _   _  ___  _ __  
| '_ ` _ \| | | |/ _ \| '_ \ 
| | | | | | |_| | (_) | | | |
|_| |_| |_|\__,_|\___/|_| |_|

*/

var pagesTemplate;
var converter = new Showdown.converter();
var user;
var currentData;
var canEdit = true;
var client;

$(document).ready(function() {
	render("splash-template", {});

	client = new Dropbox.Client({
	    key: "lRKa+aQawzA=|m5Kl+t05bYyNF2i+VhUD7L2wt/z6eNQ6OntwVQwyqQ==", sandbox: true
	});

	client.authDriver(new Dropbox.Drivers.Redirect({rememberUser : true}));

	client.authenticate(function(error, client) {
		if (error) {
			console.log(error);
			return;
		}
		console.log("authenticated");
		client.getUserInfo(function(error, userInfo) {
			if (error) {
				console.log(error);
				return;
			}
			user = userInfo;

			render("splash-template", {});
			//render("hero-template", {});
			Backbone.history.start();
		});
	});
});

function render(template, data){
	var template = Handlebars.compile($("#" + template).html());
	data.user = user;
	data.canEdit = canEdit;
	$("#container").html(template(data));
}


function getWithRetry(url, cb, notFound){
	client.readFile(url, function(error, data) {
		cb(data);
	});
}

function snapshot(url, cb){

	/*$.ajax(url + "?comp=snapshot&" + sas, {headers:{"x-ms-version": "2011-08-18"}, type:"PUT"}).done(function(data){
		cb();
	});*/
}

function uploadContent(page, content, cb){
	client.writeFile(page, content, function(error, stat) {
		if (error) {
			console.log(error);  // Something went wrong.
			return;
		}
		if (cb){
			cb();
		}
	});
}

function save(page){
	var content = editor.getValue();
	uploadContent(page, content, function(){
		//snapshot("/wiki/" + page, function(){});
		Backbone.history.navigate("page/" + page, true); 			
	});
}

function promote(page){
	uploadContent(page, currentData, function(){
		Backbone.history.navigate("page/" + page, true); 			
	});
}

function deletePage(page, cb){
	client.delete(page, function(){
		Backbone.history.navigate("/", true); 	
	})
}

function newPage(){
	bootbox.prompt("Please enter a name for the page", function(result) {                
		if (result) {                                             
			app_router.new(result);
		}
	});
}


var editor;
var AppRouter = Backbone.Router.extend({
	routes: {
		"?_dropboxjs_scope=*foo":"redirect",
		"page/:page": "page",
		"edit/:page": "edit",
		"snapshot/:snapshot/:page": "snapshot",
		"history/:page": "history",
		"" : "home",
		"*page" : "page"
	},
	redirect: function(){
		window.location = document.URL.split('?')[0];
	},
	home: function(){
		$("#mdhelp").hide();
  		
  		client.readdir("/", function(error, entries) {
  			console.log(entries);
  			render("page-template", {pages:entries});
  		});
  		
	},
	page: function(page){
		$("#mdhelp").hide();
		render("markdown-template", {page:page});

		client.readFile(page, function(error, data) {

			if (error){
				app_router.new(page);
				return;
			}

			currentData = data;
	  		var md = converter.makeHtml(data);
	  		$("#md-container").html(md);

		});
	},
	snapshot: function(snapshot, page){
		$("#mdhelp").hide();
		render("snapshot-template", {page:page, snapshot:snapshot});

		getWithRetry("/wiki/" + page + "?" + sas + "&snapshot=" + snapshot, function(data){
			currentData = data;
	  		var md = converter.makeHtml(data);
	  		$("#md-container").html(md);
	  	}, function(){
	  		app_router.new(page);
	  	});
	},	
	edit: function(page){
		if (user && !canEdit){
			render("nopermission-template", {});
			return;
		}

		client.readFile(page, function(error, data) {
			render("editor-template", {data:data, page:page});
			currentData = data;
			editor = ace.edit("editor");
			editor.setShowPrintMargin(false);
    		//editor.setTheme("ace/theme/twilight");
    		editor.focus();
    		$("#mdhelp").show();

		});
	},
	new: function(page){
		if (user && !canEdit){
			render("nopermission-template", {});
			return;
		}

  		render("new-template", {data:"", page:page});
		editor = ace.edit("editor");
		editor.setShowPrintMargin(false);
		//editor.setTheme("ace/theme/twilight");
		editor.focus();
		$("#mdhelp").show();
	},
	history: function(page){
		$("#mdhelp").hide();		
		client.revisions(page, function(error, data){
			render("history-template", {versions:data, page:page});
		});
	}
});

var app_router = new AppRouter;


		</script>
		
		<div class="container-fluid">
			<div id="container"></div>
	

		<div class="row-fluid" style="display:none" id="mdhelp">
			<h2>Help with Markdown</h2>
			<strong>Links</strong>
			
<pre>To link to another page in the Wiki:
[A Link](#ALink)
 
To link to an external page:
[Two10 Website](http://www.two10degrees.com) 
</pre>

			<strong>Formatting</strong>

<pre># Main Heading
## Sub Heading

* Bullet
* Points

1. Numbered 
1. List
</pre>

			<strong>Source Code</strong>
<pre>```js
function Hello(){
	console.log("World");
}
```</pre>

			</div>
		</div>

		<script id="splash-template" type="text/x-handlebars-template">
            <div class="hero-unit">
				<h1>Welcome to Muon Redux</h1>
				<p>The wiki built on <a href="http://db.tt/osZLMW0">Dropbox</a>.</p>
			</div>
		</script>

		<script id="hero-template" type="text/x-handlebars-template">
            <div class="hero-unit">
				<h1>Welcome to Muon Redux</h1>
				<p>The wiki built on <a href="http://db.tt/osZLMW0">Dropbox</a>.</p>
				{{#if message}}
					<div style="color:red">{{message}}</div>
				{{/if}}
				
			</div>
		</script>

		<script id="page-template" type="text/x-handlebars-template">
            <div class="row-fluid toolbar">
                <div class="toolbar-buttons">
                	<strong>Muon Redux</strong>
                	{{#if canEdit}}
                		<a href="javascript:void(0);" onclick="newPage();" class="btn">New Page</a>
                	{{/if}}
                </div>

                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}
                
            </div>
            <div class="row-fluid">
                <h2>All pages in this Wiki</h2>
			  	<ul>
				  {{#each pages}}
				  	<li><a href="#page/{{this}}">{{this}}</a></li>
				  {{/each}}
			  	</ul>
		  	</div>
		</script>

		<script id="markdown-template" type="text/x-handlebars-template">
            <div class="row-fluid toolbar">
                <div class="toolbar-buttons"><a href="#" class="btn btn-primary">All Pages</a> 
                {{#if canEdit}}
                	<a href="#edit/{{page}}" class="btn">Edit</a>
                	<a href="javascript:void(0);" onclick="newPage();" class="btn">New Page</a>
                {{/if}}
                <!--a href="#history/{{page}}" class="btn">History</a-->
		    	<strong>{{page}}</strong></div>
                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}

            </div>		
			<div class="row-fluid" id="md-container">
			</div>
		</script>

		<script id="editor-template" type="text/x-handlebars-template">
		    <div class="row-fluid toolbar">
                <div class="toolbar-buttons"><a class="btn btn-primary" href="javascript:void(0);" onclick="save('{{page}}');">Save</a> <a href="#page/{{page}}" class="btn">Cancel</a> <a href="javascript:void(0);" onclick="deletePage('{{page}}');" class="btn btn-danger">Delete</a>
		    	<strong>Edit {{page}}</strong></div>

                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}
            </div>
            <div class="row-fluid">
				<div class="ace_editor_wrapper"><div id="editor">{{data}}</div></div>
			</div>
		</script>

		<script id="new-template" type="text/x-handlebars-template">

            {{#if canEdit}}
		    <div class="row-fluid toolbar">
                <div class="toolbar-buttons"><a class="btn btn-primary" href="javascript:void(0);" onclick="save('{{page}}');">Create</a> <a href="javascript:void(0);" onclick="window.history.back()" class="btn">Cancel</a>
		    	<strong>Create {{page}}</strong></div>

                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}
            </div>
            <div class="row-fluid">
				<div class="ace_editor_wrapper"><div id="editor">{{data}}</div></div>
			</div>
			{{else}}
				<div class="row-fluid toolbar">This page does not exist.</div>
            {{/if}}

		</script>

		<script id="history-template" type="text/x-handlebars-template">
            <div class="row-fluid toolbar">
                <div class="toolbar-buttons"><a href="#" class="btn btn-primary">All Pages</a></div>
                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}

            </div>
            <div class="row-fluid">
                <h2>{{page}} version history</h2>
			  	<ul>
			  		<li><a href="#page/{{page}}">Current</a></li>
				  {{#each versions}}
				  	<li>
				  		<a href="#snapshot/{{SnapshotArg}}/{{Name}}">{{clientModifiedAt}}</a>
				  		{{#if Metadata.username}}
							 by <a href="http://www.twitter.com/{{Metadata.twitter}}">{{Metadata.username}}</a>				  		
				  		{{/if}}
				  	</li>
				  {{/each}}
			  	</ul>
		  	</div>
		</script>

		<script id="snapshot-template" type="text/x-handlebars-template">
            <div class="row-fluid toolbar">
                <div class="toolbar-buttons"><a href="#" class="btn btn-primary">All Pages</a> 
                <a href="#page/{{page}}" class="btn btn-primary">Current Version</a> 
                <a href="#history/{{page}}" class="btn">History</a>
                {{#if canEdit}}
                	<a href="javascript:void(0);" onclick="promote('{{page}}');" class="btn btn-danger">Promote to current version</a> 
                {{/if}}
		    	<strong>Historical version of {{page}}</strong></div>

                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}
            </div>		
			<div class="row-fluid" id="md-container">
			</div>
		</script>

		<script id="nopermission-template" type="text/x-handlebars-template">

  			<div class="row-fluid toolbar">
                <div class="toolbar-buttons"><strong>Muon Redux</strong></div>

                {{#if user}}
					<span class="name">{{user.name}}</span>
				{{/if}}
            </div>
            <div class="row-fluid">
				<p style="color:red">Sorry, you don't have permission to do this.</p>
		  	</div>		
		</script>

	</body>
</html>
